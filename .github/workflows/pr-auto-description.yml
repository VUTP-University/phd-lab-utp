name: Write PR Description

on:
  pull_request:
    types: [opened, synchronize]
    
permissions:
  contents: write
  pull-requests: write

jobs:
  generate-pr-description:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      # 3. Get commits from the PR
      - name: Get commits
        id: commits
        run: |
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} \
            --json commits --jq '.commits[].commit.message' | tr '\n' ' ')
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

      # 4. Generate PR description using OpenAI
      - name: Generate PR description
        id: generate
        shell: bash
        run: |
          PR_COMMITS="${{ steps.commits.outputs.commits }}"

          PAYLOAD=$(jq -n --arg commits "$PR_COMMITS" '{
            "model": "gpt-4o-mini",
            "messages": [
              {"role": "system", "content": "You are a helpful assistant."},
              {"role": "user", "content": "Generate a PR description using this template:\n\n### ğŸ§¾ Summary\n<!-- Provide a concise summary of the change. Why is this PR needed? -->\n\n## ğŸ§© Issue Description\n<!-- What is the underlying problem or task? -->\n\n## ğŸ’¡ Proposed Solution\n<!-- Describe the solution you implemented -->\n\n## ğŸ§ª Testing Instructions\n<!-- Describe how you tested your changes -->\n\n## âœ… Checklist\n- [ ] I have performed a self-review of my code.\n- [ ] I have commented my code.\n- [ ] Updated documentation (if applicable).\n- [ ] Sufficient test coverage.\n- [ ] No new warnings or errors.\n\n## ğŸ”— Related Issue(s)\n- Related to #<issue-number>\n\n## ğŸ“ Additional Notes\n<!-- Anything else reviewers should know -->\n\nThe commits included in this PR are:\n\($commits)"}
            ]
          }')

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d "$PAYLOAD")

          DESCRIPTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 5. Update PR description
      - name: Update PR description
        run: |
          cat > pr_body.md <<'EOF'
          ### ğŸ§¾ Summary
          This PR implements a new feature that enhances user authentication by adding multi-factor authentication (MFA) support. This enhancement is necessary to improve security and protect user accounts from unauthorized access.
          
          ## ğŸ§© Issue Description
          The underlying problem is that our current authentication system relies solely on password protection, which has proven to be insufficient against modern security threats. Users are at risk of account compromise due to phishing and password reuse. Implementing MFA will provide an additional layer of security, making it significantly harder for attackers to gain access.
          
          ## ğŸ’¡ Proposed Solution
          To address this issue, I have integrated an MFA solution using time-based one-time passwords (TOTP). Users can now opt to enable MFA on their accounts. Once enabled, they will be prompted for a second form of verification (a code generated by an authenticator app) during the login process.
          
          Key changes include:
          - A new settings page for users to manage their MFA preferences.
          - Backend logic to generate and verify TOTP codes.
          - Updates to the authentication flow to include MFA verification.
          
          ## ğŸ§ª Testing Instructions
          I tested the changes by:
          1. Enabling MFA for a test user account and verifying that a code is generated and sent to the authenticator app.
          2. Logging in with valid credentials followed by the TOTP code to ensure successful authentication.
          3. Attempting to log in with invalid TOTP codes to ensure access is denied.
          4. Checking the rollback process by disabling MFA and ensuring that login works with just the password.
          
          ## âœ… Checklist
          - [ ] I have performed a self-review of my code.
          - [ ] I have commented my code.
          - [ ] Updated documentation (if applicable).
          - [ ] Sufficient test coverage.
          - [ ] No new warnings or errors.
          
          ## ğŸ”— Related Issue(s)
          - Related to #123
          
          ## ğŸ“ Additional Notes
          Implementing MFA adds complexity to the authentication process, so it is crucial to update the user onboarding documentation to guide users through the setup. Additionally, I have included a feature toggle to allow users to enable or disable MFA at their discretion.
          
          The commits included in this PR are:
          - Commit 1: Introduced MFA settings in user profile.
          - Commit 2: Integrated TOTP generation and validation logic.
          - Commit 3: Updated authentication flow to include MFA verification.
          - Commit 4: Added tests for MFA functionality.
          - Commit 5: Revised documentation to include MFA setup instructions.
          EOF
      
          gh pr edit 9 --body-file pr_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
