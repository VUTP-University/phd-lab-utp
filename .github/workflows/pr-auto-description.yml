name: Auto-generate PR Description

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-pr-description:
    runs-on: ubuntu-latest

    steps:
      # Checkout PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      # Install dependencies
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # Get commit messages using git log
      - name: Get PR commits
        id: commits
        run: |
          echo "ğŸ” Fetching commits for PR #${{ github.event.pull_request.number }}..."
          
          # Fetch the base branch to compare (full history)
          git fetch --unshallow || true
          git fetch origin ${{ github.event.pull_request.base.ref }}:$GITHUB_BASE_REF
          
          # Get commit messages between base branch and PR branch
          COMMITS=$(git log $GITHUB_BASE_REF..HEAD --pretty=format:"%s")
          
          if [ -z "$COMMITS" ]; then
            echo "âŒ No commits found for this PR."
            echo "COMMITS=" >> $GITHUB_ENV
          else
            echo "ğŸ§© Captured commits:"
            echo "$COMMITS"
            echo "COMMITS<<EOF" >> $GITHUB_ENV
            echo "$COMMITS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      # Generate PR description with OpenAI
      - name: Generate PR description with OpenAI
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$COMMITS" ]; then
            echo "### ğŸ§¾ Summary\nNo commits found for this PR." > pr_body.md
            exit 0
          fi

          echo "ğŸ§  Generating PR description..."

          # Build prompt with template + commits
          cat > prompt.txt <<'EOF'
          You are a senior software engineer tasked with generating a structured and professional Pull Request (PR) description.
          
          Use the following Markdown template to produce the PR description. Fill in each section appropriately based on the commit messages provided.
          
          ### ğŸ§¾ Summary
          <!-- Provide a concise summary of the change. Why is this PR needed? -->
          
          ---
          
          ## ğŸ§© Issue Description
          <!-- What is the underlying problem or task? Include context and background if necessary. -->
          
          ---
          
          ## ğŸ’¡ Proposed Solution
          <!-- Describe the solution you implemented to resolve the issue. What approach did you take and why? -->
          
          ---
          
          ## ğŸ§ª Testing Instructions
          <!-- Describe how you tested your changes. Include specific test cases, environments, or commands used. -->
          
          - [ ] Tested locally
          - [ ] Unit tests added or updated
          - [ ] Integration tests performed
          - [ ] Verified on staging environment
          
          ---
          
          ## âœ… Checklist
          - [ ] I have performed a self-review of my code.
          - [ ] I have commented my code, especially in hard-to-understand areas.
          - [ ] I have updated documentation (if applicable).
          - [ ] The feature has sufficient test coverage.
          - [ ] No new warnings or errors introduced.
          
          ---
          
          ## ğŸ”— Related Issue(s) (if applicable)
          - Related to #<issue-number>
          
          ---
          
          ## ğŸ“ Additional Notes (Optional)
          <!-- Anything else reviewers should know (e.g., known issues, deployment notes, migrations)? -->
          
          ---
          
          Commit messages for this PR:
          EOF

          # Append commit messages
          echo "$COMMITS" >> prompt.txt

          # Prepare JSON safely for OpenAI API
          BODY=$(jq -Rs --arg model "gpt-4o-mini" \
            '{model: $model, messages: [{role: "user", content: .}], max_tokens: 1200}' < prompt.txt)

          # Call OpenAI API
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            --data "$BODY")

          DESCRIPTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$DESCRIPTION" ]; then
            echo "âš ï¸ OpenAI did not return a valid description. Using fallback."
            DESCRIPTION="### ğŸ§¾ Summary\nAuto-generated PR description could not be generated.\n\nCommits:\n$COMMITS"
          fi

          echo "$DESCRIPTION" > pr_body.md
          echo "$DESCRIPTION"

      # Update PR description
      - name: Update PR description
        run: gh pr edit ${{ github.event.pull_request.number }} --body-file pr_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
