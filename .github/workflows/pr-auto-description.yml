name: Write PR Description

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-pr-description:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Get commits from the PR
      - name: Get commits
        id: commits
        run: |
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].commit.message')
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

      # 3. Generate summary using OpenAI
      - name: Generate PR description
        id: generate
        uses: peter-evans/openai-gpt-action@v2
        with:
          model: gpt-4
          input: |
            You are a helpful assistant. Create a PR description using this template:
            ### ğŸ§¾ Summary
            <!-- Provide a concise summary of the change. Why is this PR needed? -->
            ---
            ## ğŸ§© Issue Description
            <!-- What is the underlying problem or task? -->
            ---
            ## ğŸ’¡ Proposed Solution
            <!-- Describe the solution you implemented -->
            ---
            ## ğŸ§ª Testing Instructions
            <!-- Describe how you tested your changes -->
            ---
            ## âœ… Checklist
            - [ ] I have performed a self-review of my code.
            - [ ] I have commented my code.
            - [ ] Updated documentation (if applicable).
            - [ ] Sufficient test coverage.
            - [ ] No new warnings or errors.
            ---
            ## ğŸ”— Related Issue(s) (if applicable)
            - Related to #<issue-number>
            ---
            ## ğŸ“ Additional Notes (Optional)
            <!-- Anything else reviewers should know -->

            The commits included in this PR are:
            ${{ steps.commits.outputs.commits }}

          api-key: ${{ secrets.OPENAI_API_KEY }}

      # 4. Update the PR description
      - name: Update PR
        uses: peter-evans/pull-request@v4
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.generate.outputs.completion }}
