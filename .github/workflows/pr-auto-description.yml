name: Auto-generate PR Description

on:
  pull_request:
    types: [opened, synchronize, reopened]
    
permissions:
  contents: write
  pull-requests: write

jobs:
  generate-pr-description:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR commits
        id: commits
        run: |
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].message')
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate AI-based PR description
        id: ai
        run: |
          # Create the prompt for the AI model using your structured template
          cat > prompt.txt <<'EOF'
          You are a senior developer assistant.
          Generate a **Pull Request description** using the following Markdown template.
          Fill in each section based on the commit messages provided below.
          Be professional, concise, and use Markdown formatting.

          TEMPLATE:
          ### ğŸ§¾ Summary
          <!-- Provide a concise summary of the change. Why is this PR needed? -->

          ---

          ## ğŸ§© Issue Description
          <!-- What is the underlying problem or task? Include context and background if necessary. -->

          ---

          ## ğŸ’¡ Proposed Solution
          <!-- Describe the solution you implemented to resolve the issue. What approach did you take and why? -->

          ---

          ## ğŸ§ª Testing Instructions
          <!-- Describe how you tested your changes. Include specific test cases, environments, or commands used. -->

          - [ ] Tested locally
          - [ ] Unit tests added or updated
          - [ ] Integration tests performed
          - [ ] Verified on staging environment

          ---

          ## âœ… Checklist
          - [ ] I have performed a self-review of my code.
          - [ ] I have commented my code, especially in hard-to-understand areas.
          - [ ] I have updated documentation (if applicable).
          - [ ] The feature has sufficient test coverage.
          - [ ] No new warnings or errors introduced.

          ---

          ## ğŸ”— Related Issue(s) (if applicable)
          - Related to #<issue-number>

          ---

          ## ğŸ“ Additional Notes (Optional)
          <!-- Anything else reviewers should know (e.g., known issues, deployment notes, migrations)? -->

          ---

          The commit messages are:
          EOF

          echo "${COMMITS}" >> prompt.txt

          # Generate description using OpenAI
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4o-mini",
              "messages": [{"role": "user", "content": "'"$(cat prompt.txt | sed 's/"/\\"/g')"'" }],
              "max_tokens": 1200
            }' | jq -r '.choices[0].message.content')

          echo "$RESPONSE" > pr_body.md

      - name: Update PR Description
        run: gh pr edit ${{ github.event.pull_request.number }} --body-file pr_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
